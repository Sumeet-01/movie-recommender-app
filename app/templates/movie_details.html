{% extends 'base.html' %}

{% block head %}
<script>document.addEventListener('DOMContentLoaded',()=>{const n=document.getElementById('navbar');if(n)n.classList.add('navbar-transparent');});</script>
{% endblock %}

{% block content %}
<!-- DETAIL HERO -->
<section class="detail-hero">
  <div class="detail-hero-bg" style="background-image: url('{{ movie.backdrop_url or '' }}')"></div>
  <div class="detail-content">
    <div class="detail-poster">
      {% if movie.poster_url %}
      <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
      {% else %}
      <div class="no-poster" style="height:420px;">üé¨</div>
      {% endif %}
    </div>
    <div class="detail-info">
      <h1 class="detail-title">{{ movie.title }}</h1>
      {% if movie.tagline %}
      <p class="detail-tagline">"{{ movie.tagline }}"</p>
      {% endif %}
      <div class="detail-meta">
        <span><span class="star-big">‚òÖ</span> {{ '%.1f'|format(movie.vote_average or 0) }}/10</span>
        <span>{{ movie.vote_count or 0 }} votes</span>
        {% if movie.runtime %}<span>{{ movie.runtime }} min</span>{% endif %}
        {% if movie.release_date %}<span>{{ movie.release_date }}</span>{% endif %}
        {% if movie.original_language %}<span>{{ movie.original_language|upper }}</span>{% endif %}
      </div>
      <div class="detail-genres">
        {% for g in movie.genres or [] %}
        <a href="{{ url_for('main.genre', genre_id=g.id) }}" class="detail-genre-tag">{{ g.name }}</a>
        {% endfor %}
      </div>
      {% if movie.overview %}
      <p class="detail-overview">{{ movie.overview }}</p>
      {% endif %}
      <!-- OTT Providers -->
      {% if ott_providers %}
      <div class="ott-providers">
        <span class="ott-label">Available on</span>
        {% for p in ott_providers %}
        <span class="ott-badge" style="background: {{ p.color }}; color: white;">
          {% if p.logo %}
          <img src="{{ p.logo }}" alt="{{ p.name }}" class="ott-logo">
          {% endif %}
          {{ p.name }}
        </span>
        {% endfor %}
      </div>
      {% endif %}

      {% if movie.director %}
      <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
        Directed by <strong style="color: var(--text-primary);">{{ movie.director }}</strong>
      </div>
      {% endif %}

      <div class="detail-actions">
        {% if trailers %}
        <button class="btn btn-primary" onclick="playTrailer('{{ trailers[0].key }}')">
          <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          Watch Trailer
        </button>
        {% endif %}
        {% if current_user.is_authenticated %}
        <button class="btn btn-secondary" id="watchlistBtn" onclick="toggleWatchlist({{ movie.id }}, {{ 'true' if in_watchlist else 'false' }})">
          <svg viewBox="0 0 24 24" fill="{{ 'currentColor' if in_watchlist else 'none' }}" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          {{ 'In Watchlist' if in_watchlist else 'Add to Watchlist' }}
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<div class="detail-body">

  <!-- User Rating -->
  {% if current_user.is_authenticated %}
  <div class="detail-section">
    <h3 class="detail-section-title">‚≠ê Your Rating</h3>
    <div class="rating-widget" data-tmdb="{{ movie.id }}">
      {% for i in range(1, 11) %}
      <span class="rating-star {% if user_rating and user_rating >= i * 0.5 %}active{% endif %}" data-value="{{ i * 0.5 }}">{{ '‚òÖ' if i % 2 == 0 else '‚òÜ' }}</span>
      {% endfor %}
      <span id="ratingLabel" style="margin-left: 12px; color: var(--text-muted); font-size: 0.9rem;">
        {% if user_rating %}{{ user_rating }}/5{% else %}Click to rate{% endif %}
      </span>
    </div>
  </div>
  {% endif %}

  <!-- Cast -->
  {% set credits = movie.get('credits', {}) %}
  {% set cast = credits.get('cast', [])[:15] %}
  {% if cast %}
  <div class="detail-section">
    <h3 class="detail-section-title">üé≠ Cast</h3>
    <div class="cast-grid stagger">
      {% for person in cast %}
      <div class="cast-card animate-fade-up">
        {% if person.profile_path %}
        <img src="https://image.tmdb.org/t/p/w185{{ person.profile_path }}" alt="{{ person.name }}">
        {% else %}
        <img src="https://via.placeholder.com/100x100.png?text={{ person.name[0] }}" alt="{{ person.name }}">
        {% endif %}
        <div class="cast-name">{{ person.name }}</div>
        <div class="cast-char">{{ person.character }}</div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Trailers -->
  {% if trailers %}
  <div class="detail-section">
    <h3 class="detail-section-title">üé¨ Trailers & Videos</h3>
    <div class="movie-row">
      {% for v in trailers %}
      <div style="flex-shrink:0; width:320px; cursor:pointer;" onclick="playTrailer('{{ v.key }}')">
        <div style="position:relative; border-radius: var(--radius); overflow: hidden;">
          <img src="https://img.youtube.com/vi/{{ v.key }}/hqdefault.jpg" alt="{{ v.name }}" style="width:100%; border-radius: var(--radius);">
          <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3);">
            <div style="width:48px; height:48px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center;">
              <svg viewBox="0 0 24 24" fill="white" width="20" height="20"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            </div>
          </div>
        </div>
        <p style="font-size:0.85rem; margin-top:8px; font-weight:500;">{{ v.name }}</p>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Similar Movies -->
  {% if similar_movies %}
  <div class="detail-section">
    <h3 class="detail-section-title">üéØ Similar Movies</h3>
    <div class="movie-row stagger">
      {% for m in similar_movies %}
      {% include 'partials/movie_card.html' %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Reviews -->
  {% if reviews %}
  <div class="detail-section">
    <h3 class="detail-section-title">üí¨ Reviews</h3>
    {% for r in reviews %}
    <div class="review-card">
      <div class="review-header">
        <span class="review-author">{{ r.user.username if r.user else 'Anonymous' }}</span>
        {% if r.rating %}<span class="review-rating">‚òÖ {{ r.rating }}</span>{% endif %}
      </div>
      {% if r.title %}<strong>{{ r.title }}</strong>{% endif %}
      <p class="review-text">{{ r.content }}</p>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Movie Info (Production, Budget, etc.) -->
  <div class="detail-section">
    <h3 class="detail-section-title">üìä Movie Info</h3>
    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:16px;">
      {% if movie.budget and movie.budget > 0 %}
      <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius); border:1px solid var(--border);">
        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Budget</div>
        <div style="font-size:1.1rem; font-weight:700; margin-top:4px;">${{ '{:,.0f}'.format(movie.budget) }}</div>
      </div>
      {% endif %}
      {% if movie.revenue and movie.revenue > 0 %}
      <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius); border:1px solid var(--border);">
        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Revenue</div>
        <div style="font-size:1.1rem; font-weight:700; margin-top:4px;">${{ '{:,.0f}'.format(movie.revenue) }}</div>
      </div>
      {% endif %}
      {% if movie.popularity %}
      <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius); border:1px solid var(--border);">
        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Popularity</div>
        <div style="font-size:1.1rem; font-weight:700; margin-top:4px;">{{ '%.1f'|format(movie.popularity) }}</div>
      </div>
      {% endif %}
      {% if movie.status %}
      <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius); border:1px solid var(--border);">
        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Status</div>
        <div style="font-size:1.1rem; font-weight:700; margin-top:4px;">{{ movie.status }}</div>
      </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
